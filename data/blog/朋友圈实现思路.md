
# 朋友圈的实现思路

在微信叫朋友圈，在qq叫好友动态（以前叫个人中心），都是显示好友最近发布的内容。

用户发布的内容可能有各种类型，只查一个模块是不准确的，比如qq空间里面有：说说、日志、相册、分享……，而qq的好友动态里面，这些东西都是同一个列表显示的。

## 方案一：一个用户一个bucket，实时推送

为每个用户维护一个bucket，当ta的友好发布内容了，就实时推送到ta的bucket。
这种方案，乍看很好，可是存在很多问题：

- 某人发布、修改、删除内容的时候，都要推送给ta的粉丝，如果此人粉丝特别多，那就会推送很久，ta有些粉丝立即收到了更新，而有些要一个小时之后才收到，实时性太差，不能接受
- 删除好友的时候，需要重构自己的bucket，从对方列表删除，则需要重构双方bucket
- 设置朋友圈权限的时候，需要重构所有粉丝的bucket
- 每个用户一个bucket，需要很大空间

## 方案二：公用数据池，自行拉取

把用户发布的内容，同时冗余一份到这里，大概字段如下：
```
id, item_id, type, content, user_id, add_time, update_time
```
然后每个用户根据自己好友的user_id从这里拉取数据。

### 关于数据的写入

可以是用户发布内容的时候，实时触发，异步写入；
也可以是程序定时从相关表取数据。

### 缺点

如果想在朋友圈只显示添加好友之后的内容，这种方案就存在一点问题。
比如，我有两个好友，小a和小b，添加小a的时间是2017-09-01，添加小b的时间是2017-11-10，在我的朋友圈要显示添加ta们之后的时间，ta们发布的内容，sql语句要这么写：
```
select * from `table` where user_id='小a' and add_time>='2017-09-01'
select * from `table` where user_id='小b' and add_time>='2017-11-10'
```
也就是要为每个好友单独写一条sql语句，系统开销肯定很大啦
