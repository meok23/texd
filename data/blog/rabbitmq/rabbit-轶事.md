## 先介绍一下背景

生产者在前台发送消息，同时把消息的相关详情写入到 queue 表中，消费者接收到消息，并到 queue 表中取回相关的内容。生产者是由 url 触发的，消费者是守护进程执行的 php 命令。

这个模型肯定是不合理的，使用了消息队列其实是不需要也不应该再使用 queue 表的了，不过我接下来要讨论的不是这个。

## 引子

我发现，queue 表中的 add_time > update_time，查看相关代码，却没有什么逻辑不合理的地方。
add_time 是消费者写的，update_time 是生产者写的。

## 开始排查

代码没有异常。

1. 那么，开始怀疑是负载均衡的问题：消费者和生产者可能是使用了不同的机器，询问领导，被告知没有负载均衡，询问运维，居然告诉我说不清楚。

2. 写了新的实例，继续排查，发现这个实例居然执行不成功。查询代码没有问题，查询 RabbitMQ 的管理后台，也正常，生产者正常，消费者直接访问也正常，继承特定类也不正常。

3. 再度怀疑消费者和生产者使用了不同的机器，并且，消费者机器的部分代码没有同步更新。ping 相关域名，虽然结果都是指向一个IP，可是负载均衡是会做转发的，所以，ping 的结果没有参考意义。

4. 消费者是守护进程后台执行的，不容易调试，则使用日志调试。直接在 php 代码执行 ls cat ifconfig 等 Linux 命令，把结果写入日志，验证了最初的猜想，消费者和生产者使用了不同的机器，且消费者部分代码没有成功同步更新。
